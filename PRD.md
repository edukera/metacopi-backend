## üìò Utilisateur (`User`)

Repr√©sente un compte utilisateur de la plateforme. Chaque utilisateur peut avoir diff√©rents r√¥les.

### Champs

| Champ           | Type                      | Description                                                                 |
|-----------------|---------------------------|-----------------------------------------------------------------------------|
| `_id`           | string (ObjectId)         | Identifiant unique (g√©n√©r√© par MongoDB, expos√© en tant que `id` dans l'API)  |
| `email`         | string                    | Adresse email unique (automatiquement trim & lowercase)                       |
| `password`      | string                    | Hash du mot de passe (requis, `writeOnly` dans l'API)                        |
| `firstName`     | string                    | Pr√©nom (automatiquement trim)                                                 |
| `lastName`      | string                    | Nom de famille (automatiquement trim)                                       |
| `avatarUrl`     | string \| undefined       | URL d'un avatar (optionnel)                                                 |
| `emailVerified` | boolean (d√©faut: `false`) | Indique si l'email de l'utilisateur a √©t√© v√©rifi√©                             |
| `role`          | `UserRole` (enum)         | R√¥le global: `"admin"` \| `"user"` (d√©faut: `"user"`)                       |
| `createdAt`     | Date                      | Date de cr√©ation (automatiquement g√©r√©e par la base de donn√©es)               |
| `updatedAt`     | Date                      | Date de derni√®re modification (automatiquement g√©r√©e par la base de donn√©es)  |

### Relations

- `memberships`: Liste des inscriptions √† des classes (via `Membership`)

---

## üè´ Classe (`Class`)

Une classe correspond √† un groupe d'utilisateurs. Chaque classe est cr√©√©e par un enseignant et peut √™tre rejointe via un code d'acc√®s temporaire.

### Champs

| Champ           | Type          | Description                                          |
|----------------|---------------|------------------------------------------------------|
| `_id`           | string (UUID) | Identifiant unique                                  |
| `name`          | string        | Nom de la classe donn√© par l'enseignant             |
| `desc`          | string        | Description libre                                    |
| `level`         | string        | Niveau libre (ex: "2nde", "Terminale", etc.)        |
| `year`          | number        | Ann√©e scolaire (ex: 2024)                            |
| `code`          | string        | Code d'acc√®s temporaire pour rejoindre la classe     |
| `codeCreatedAt` | Date          | Date de g√©n√©ration du code d'acc√®s (valable 3 jours)|
| `archived`      | boolean       | Indique si la classe est archiv√©e                   |
| `createdAt`     | Date          | Date de cr√©ation                                    |

### Relations

- `memberships`: Liste des utilisateurs inscrits (via `Membership`)

---

## üë• Inscription √† une classe (`Membership`)

Repr√©sente le lien entre un utilisateur et une classe. Ce lien contient aussi le r√¥le (√©l√®ve, enseignant) et l'√©tat d'activation.

### Champs

| Champ       | Type          | Description                                          |
|-------------|---------------|------------------------------------------------------|
| `_id`       | string (UUID) | Identifiant unique                                  |
| `userId`    | string        | R√©f√©rence vers `User._id`                           |
| `classId`   | string        | R√©f√©rence vers `Class._id`                          |
| `role`      | string        | "Student", "Teacher" (extensible)              |
| `status`    | string        | "pending", "active", "removed"               |
| `joinedAt`  | Date          | Date d'entr√©e dans la classe                        |
| `isActive`  | boolean       | Active ou non (suppression logique, default: `true`)|

### Contraintes

- Unicit√© du couple `(userId, classId)` : un utilisateur ne peut avoir qu'un r√¥le dans une classe √† la fois.

---

## üìú T√¢che (`Task`)

Repr√©sente un devoir ou une activit√© cr√©√©e par un enseignant pour une classe donn√©e. Elle contient un √©nonc√©, une description interne, une √©ventuelle date limite, et peut inclure des ressources compl√©mentaires.

### Champs

| Champ         | Type                  | Description                                                |
|---------------|-----------------------|------------------------------------------------------------|
| `_id`         | string (UUID)         | Identifiant unique                                         |
| `title`       | string                | Titre de la t√¢che                                          |
| `description` | string                | Description interne ou administrative                      |
| `utterance`   | string \| null        | √ânonc√© √† destination des √©l√®ves                            |
| `imageUrl`    | string \| null        | URL d'une image compl√©mentaire (S3)                        |
| `dueDate`     | Date \| null          | Date limite de remise (optionnelle)                        |
| `status`      | string                | "draft" \| "published" \| "archived"                 |
| `classId`     | string                | R√©f√©rence vers la classe cible                             |
| `createdById` | string                | R√©f√©rence vers l'utilisateur cr√©ateur                      |
| `createdAt`   | Date                  | Date de cr√©ation                                           |
| `publishedAt` | Date \| null          | Date de publication                                        |
| `closedAt`    | Date \| null          | Date de cl√¥ture √©ventuelle de la t√¢che                     |
| `resources`   | TaskResource[]        | Liste des fichiers li√©s √† la t√¢che                         |

### Relations

- `class`: Classe √† laquelle la t√¢che est assign√©e
- `createdBy`: Enseignant ayant cr√©√© la t√¢che
- `copies`: Soumissions rendues par les √©l√®ves (1 par √©l√®ve)

---

## üìå Ressource attach√©e √† une t√¢che (`TaskResource`)

Ressource p√©dagogique li√©e √† une t√¢che, stock√©e sur un bucket S3.

### Champs (inline dans `Task.resources[]`)

| Champ               | Type        | Description                                          |
|--------------------|-------------|------------------------------------------------------|
| `name`             | string      | Nom affich√© (ex: "√ânonc√©", "Correction")            |
| `s3Key`            | string      | Cl√© S3 du fichier                                    |
| `mimeType`         | string      | Type MIME (ex: "application/pdf")                   |
| `visibleToStudents`| boolean     | Visibilit√© pour les √©l√®ves (`true` ou `false`)      |

---

## üìÑ Soumission (`Submission`)

Repr√©sente le rendu d'un √©l√®ve pour une t√¢che donn√©e. Chaque √©l√®ve ne peut soumettre qu'une seule fois par t√¢che.

### Champs

| Champ            | Type              | Description                                                |
|------------------|-------------------|------------------------------------------------------------|
| `_id`            | string (UUID)     | Identifiant unique                                         |
| `studentId`      | string            | R√©f√©rence vers l'√©l√®ve ayant soumis                        |
| `taskId`         | string            | R√©f√©rence vers la t√¢che associ√©e                           |
| `uploadedBy`     | string            | R√©f√©rence vers l'utilisateur ayant upload√© (prof ou √©l√®ve)     |
| `status`         | string            | "draft" \| "submitted" \| "corrected" \| "archived" |
| `rawPages`       | string[]          | Cl√©s S3 des images originales (non trait√©es)               |
| `processedPages` | string[]          | Cl√©s S3 des images trait√©es (redress√©es)                    |
| `createdAt`      | Date              | Date de cr√©ation (auto)                                    |
| `submittedAt`    | Date \| null      | Date effective de soumission                               |
| `reviewedAt`     | Date \| null      | Date de validation ou de correction                        |

### Contraintes

- Une seule soumission par √©l√®ve et par t√¢che (`unique: [studentId, taskId]`)

---

## ‚úèÔ∏è Correction (`Correction`)

Repr√©sente la correction d'une copie (`Submission`) faite par un enseignant. Contient les annotations, la note globale, l'appr√©ciation finale, ainsi que les dates cl√©s.

### Champs

| Champ          | Type              | Description                                                |
|----------------|-------------------|------------------------------------------------------------|
| `_id`          | string (UUID)     | Identifiant unique                                         |
| `submissionId` | string            | R√©f√©rence vers la copie soumise                            |
| `correctedById`| string            | R√©f√©rence vers l'enseignant ayant corrig√©                  |
| `status`       | string            | "in_progress" \| "completed"                           |
| `annotations`  | string            | Donn√©es de correction (texte ou JSON libre)                |
| `grade`        | number            | Note globale attribu√©e √† la copie                          |
| `appreciation` | string            | Appr√©ciation finale r√©dig√©e                                |
| `createdAt`    | Date              | Date de cr√©ation                                           |
| `updatedAt`    | Date              | Derni√®re modification                                      |
| `finalizedAt`  | Date \| null      | Date de finalisation de la correction                      |

### Contraintes

- Une seule correction par `submission` (`unique: submissionId`)

---

## üí¨ Commentaire (`Comment`)

Repr√©sente un commentaire associ√© √† une soumission. Permet aux enseignants et √©l√®ves de discuter d'une copie.

### Champs

| Champ          | Type              | Description                                                |
|----------------|-------------------|------------------------------------------------------------|
| `_id`          | string (UUID)     | Identifiant unique                                         |
| `submissionId` | string            | R√©f√©rence vers la copie soumise                            |
| `userId`       | string            | R√©f√©rence vers l'utilisateur ayant cr√©√© le commentaire     |
| `content`      | string            | Contenu textuel du commentaire                             |
| `parentId`     | string \| null    | R√©f√©rence vers un commentaire parent (r√©ponses)            |
| `createdAt`    | Date              | Date de cr√©ation                                           |
| `updatedAt`    | Date              | Derni√®re modification                                      |

### Relations

- `submission`: Soumission √† laquelle le commentaire est attach√©
- `user`: Utilisateur ayant cr√©√© le commentaire
- `parent`: Commentaire parent (si r√©ponse)
- `replies`: Liste des r√©ponses √† ce commentaire

---

## üîç Annotation (`Annotation`)

Repr√©sente une annotation sp√©cifique attach√©e √† une partie pr√©cise d'une soumission, avec des m√©tadonn√©es JSON.

### Champs

| Champ          | Type              | Description                                                |
|----------------|-------------------|------------------------------------------------------------|
| `_id`          | string (UUID)     | Identifiant unique                                         |
| `submissionId` | string            | R√©f√©rence vers la copie soumise                            |
| `userId`       | string            | R√©f√©rence vers l'utilisateur ayant cr√©√© l'annotation       |
| `pageNumber`   | number            | Num√©ro de la page concern√©e (1-index√©)                     |
| `position`     | object            | Position sur la page `{x: number, y: number, width: number, height: number}` |
| `metadata`     | object            | M√©tadonn√©es JSON (contenu, type, etc.)                     |
| `createdAt`    | Date              | Date de cr√©ation                                           |
| `updatedAt`    | Date              | Derni√®re modification                                      |

### Relations

- `submission`: Soumission √† laquelle l'annotation est attach√©e
- `user`: Utilisateur ayant cr√©√© l'annotation

---

## üìÖ Journal d'activit√©s (`AuditLog`)

Permet de tracer les actions utilisateur importantes pour le suivi et la transparence.

### Champs

| Champ         | Type           | Description                                         |
|---------------|----------------|-----------------------------------------------------|
| `_id`         | string (UUID)  | Identifiant unique                                 |
| `userId`      | string         | R√©f√©rence vers l'utilisateur ayant agi             |
| `action`      | string         | Description courte de l'action                     |
| `targetType`  | string         | Type d'entit√© vis√©e ("Task", "Submission", etc.)    |
| `targetId`    | string         | Identifiant de l'entit√© cible                      |
| `timestamp`   | Date           | Date et heure de l'action                          |
| `valueBefore` | string         | Valeur avant l'action                          |
| `valueAfter`  | string         | Valeur apr√®s l'action                          |



## üìö API ‚Äì Gestion des Classes & Inscriptions

### ‚úÖ [POST] /classes  
Cr√©e une nouvelle classe (enseignant)

#### Input
```json
{
  "name": "Sp√© Maths 1",
  "desc": "Groupe A - Terminale",
  "level": "Terminale",
  "year": 2025
}
```

#### R√®gles
- L'utilisateur doit √™tre authentifi√©
- Un code d'acc√®s est g√©n√©r√© automatiquement
- `Membership` cr√©√© automatiquement avec `role: "Teacher"`

---

### ‚úÖ [GET] /classes  
Liste les classes visibles par l'utilisateur

#### R√®gles
- Si `User.role = "admin"` ‚Üí retourne toutes les classes
- Sinon ‚Üí retourne les classes li√©es √† l'utilisateur via `Membership`

---

### ‚úÖ [POST] /classes/join  
Rejoindre une classe avec un code d'acc√®s

#### Input
```json
{
  "code": "ABC123"
}
```

#### R√®gles
- Le code doit exister et avoir √©t√© g√©n√©r√© depuis moins de 3 jours
- Cr√©e un `Membership` avec `role: "Student"` si non existant
- Retourne une erreur si l'utilisateur est d√©j√† membre

---

### ‚úÖ [GET] /classes/:id/members  
Liste les membres d'une classe, regroup√©s par r√¥le

#### R√®gles
- Autoris√© pour :
  - Membres `Teacher` de la classe
  - Utilisateurs `admin`

---

### ‚úÖ [PATCH] /classes/:id/archive  
Archive une classe (readonly)

#### R√®gles
- Seul un `Teacher` ou `admin` peut archiver une classe
- Met √† jour le champ `archived = true`
- Les √©l√®ves ne peuvent plus interagir avec les t√¢ches/soumissions de cette classe

---

### ‚úÖ [POST] /classes/:id/regenerate-code  
R√©g√©n√®re le code d'acc√®s d'une classe

#### R√®gles
- R√©serv√© aux enseignants ou admins
- G√©n√®re un nouveau code + met √† jour `codeCreatedAt`

---

## üìò API ‚Äì Gestion des T√¢ches (`Task`)

### ‚úÖ [POST] /tasks  
Cr√©e une nouvelle t√¢che dans une classe

#### Input
```json
{
  "title": "DM n¬∞2 - Suites num√©riques",
  "description": "√Ä rendre avant vendredi",
  "utterance": "R√©soudre les exercices 3 √† 6 page 45.",
  "imageUrl": "https://s3.amazonaws.com/bucket/images/sujet.png",
  "dueDate": "2025-03-01T23:59:59Z",
  "classId": "abc123"
}
```

#### R√®gles
- L'utilisateur doit √™tre `Teacher` dans la classe cible
- `status` initial = "draft"
- `createdById` est automatiquement rempli

---

### ‚úÖ [GET] /tasks/:id  
Retourne les d√©tails d'une t√¢che

#### R√®gles
- Accessible aux enseignants et √©l√®ves **membres de la classe**
- Les ressources `visibleToStudents: false` sont masqu√©es pour les √©l√®ves

---

### ‚úÖ [GET] /classes/:classId/tasks  
Liste toutes les t√¢ches d'une classe

#### R√®gles
- Filtrage possible par statut (`draft`, `published`, `archived`)
- R√©sultat adapt√© selon le r√¥le :
  - √©l√®ve = uniquement t√¢ches publi√©es
  - enseignant = toutes les t√¢ches

---

### ‚úÖ [PATCH] /tasks/:id  
Met √† jour les champs d'une t√¢che

#### Input (exemple)
```json
{
  "title": "DM n¬∞2 - Suites et fonctions",
  "dueDate": "2025-03-03T23:59:59Z"
}
```

#### R√®gles
- L'utilisateur doit √™tre `Teacher` ou `admin`
- Seules les t√¢ches non archiv√©es peuvent √™tre modifi√©es

---

### ‚úÖ [PATCH] /tasks/:id/publish  
Publie une t√¢che

#### R√®gles
- Passe `status` √† `published`
- Remplit `publishedAt`
- Les t√¢ches publi√©es ne sont modifiables que par un `admin`

---

### ‚úÖ [PATCH] /tasks/:id/archive  
Archive une t√¢che

#### R√®gles
- Passe `status` √† `archived`
- Cl√¥t les soumissions
- R√©serv√© aux `Teacher` ou `admin`

---

### ‚úÖ [POST] /tasks/:id/resources  
Ajoute une ressource √† une t√¢che

#### Input
```json
{
  "name": "Corrig√© officiel",
  "s3Key": "uploads/dm2/correction.pdf",
  "mimeType": "application/pdf",
  "visibleToStudents": false
}
```

#### R√®gles
- Append dans `resources[]`
- R√©serv√© aux enseignants

---

### ‚úÖ [DELETE] /tasks/:taskId/resources/:index  
Supprime une ressource par son index dans le tableau

#### R√®gles
- Autoris√© uniquement aux enseignants ou `admin`
- Ne supprime pas le fichier sur S3

---

## üìù API ‚Äì Soumissions (`Submission`)

### ‚úÖ [POST] /submissions  
Cr√©e une soumission (copie de l'√©l√®ve pour une t√¢che)

#### Input
```json
{
  "taskId": "abc123",
  "rawPages": [
    "uploads/subm1/page1.jpg",
    "uploads/subm1/page2.jpg"
  ]
}
```

#### R√®gles
- L'utilisateur doit √™tre `Student` dans la classe
- Une seule soumission par (user, task)
- `uploadedBy` rempli automatiquement

---

### ‚úÖ [GET] /tasks/:taskId/submissions  
Liste les soumissions √† une t√¢che

#### R√®gles
- R√©serv√© aux `Teacher` et `admin`

---

### ‚úÖ [GET] /submissions/:id  
D√©tail d'une soumission

#### R√®gles
- Accessible par :
  - l'√©l√®ve auteur
  - les `Teacher` ou `admin`

---

### ‚úÖ [PATCH] /submissions/:id  
Met √† jour une soumission

#### Input
```json
{
  "processedPages": [
    "uploads/subm1/page1-cleaned.jpg",
    "uploads/subm1/page2-cleaned.jpg"
  ],
  "status": "submitted"
}
```

#### R√®gles
- Modifiable uniquement par l'auteur ou un `Teacher`
- Passage √† `submitted` remplit `submittedAt`

---

## ‚úèÔ∏è API ‚Äì Corrections (`Correction`)

### ‚úÖ [POST] /corrections  
Cr√©e une correction pour une soumission

#### Input
```json
{
  "submissionId": "xyz123",
  "annotations": "{...}",
  "grade": 14.5,
  "appreciation": "Bon travail, attention aux erreurs d'√©tourderie."
}
```

#### R√®gles
- Une seule correction par `submission`
- R√©serv√© aux `Teacher` ou `admin`

---

### ‚úÖ [GET] /submissions/:submissionId/correction  
R√©cup√®re la correction li√©e √† une soumission

#### R√®gles
- Accessible √† l'√©l√®ve concern√©, `Teacher`, ou `admin`

---

### ‚úÖ [PATCH] /corrections/:id  
Met √† jour la correction

#### R√®gles
- Possible uniquement si `status != completed`, sauf pour `admin`
- Passage √† `completed` remplit `finalizedAt`

---

## üí¨ API ‚Äì Commentaires (`Comment`)

### ‚úÖ [POST] /comments  
Cr√©e un nouveau commentaire sur une soumission

#### Input
```json
{
  "submissionId": "xyz123",
  "content": "Excellent travail sur cette partie du devoir",
  "parentId": null
}
```

#### R√®gles
- L'utilisateur doit √™tre membre de la classe (enseignant ou √©l√®ve)
- `userId` est automatiquement ajout√©
- `parentId` est optionnel (null si commentaire racine)

---

### ‚úÖ [GET] /comments/submission/:submissionId  
Liste les commentaires d'une soumission

#### R√®gles
- Accessible au propri√©taire de la soumission et aux enseignants de la classe
- Retourne les commentaires organis√©s en thread (commentaires + r√©ponses)

---

### ‚úÖ [GET] /comments/:id  
R√©cup√®re un commentaire sp√©cifique

#### R√®gles
- Accessible aux membres de la classe concern√©e

---

### ‚úÖ [PATCH] /comments/:id  
Met √† jour un commentaire

#### Input
```json
{
  "content": "Contenu modifi√© du commentaire"
}
```

#### R√®gles
- Modifiable uniquement par l'auteur du commentaire
- Les administrateurs peuvent modifier tous les commentaires

---

### ‚úÖ [DELETE] /comments/:id  
Supprime un commentaire

#### R√®gles
- Supprimable par l'auteur du commentaire
- Les enseignants peuvent supprimer les commentaires de leur classe
- Les administrateurs peuvent supprimer n'importe quel commentaire

---

## üîç API ‚Äì Annotations (`Annotation`)

### ‚úÖ [POST] /annotations  
Cr√©e une nouvelle annotation sur une soumission

#### Input
```json
{
  "submissionId": "xyz123",
  "pageNumber": 2,
  "position": {
    "x": 150,
    "y": 200,
    "width": 100,
    "height": 50
  },
  "metadata": {
    "type": "highlight",
    "color": "yellow",
    "comment": "Tr√®s bonne explication"
  }
}
```

#### R√®gles
- Accessible aux enseignants de la classe
- `userId` est automatiquement ajout√©
- Le format JSON de `metadata` est flexible

---

### ‚úÖ [GET] /annotations/submission/:submissionId  
Liste les annotations d'une soumission

#### R√®gles
- Accessible au propri√©taire de la soumission et aux enseignants de la classe
- Peut √™tre filtr√© par page avec `?pageNumber=2`

---

### ‚úÖ [GET] /annotations/:id  
R√©cup√®re une annotation sp√©cifique

#### R√®gles
- Accessible aux membres de la classe concern√©e

---

### ‚úÖ [PATCH] /annotations/:id  
Met √† jour une annotation

#### Input
```json
{
  "position": {
    "x": 160,
    "y": 210,
    "width": 120,
    "height": 60
  },
  "metadata": {
    "type": "highlight",
    "color": "red",
    "comment": "Erreur de calcul ici"
  }
}
```

#### R√®gles
- Modifiable uniquement par l'auteur de l'annotation
- Les champs peuvent √™tre mis √† jour partiellement

---

### ‚úÖ [DELETE] /annotations/:id  
Supprime une annotation

#### R√®gles
- Supprimable par l'auteur de l'annotation
- Les administrateurs peuvent supprimer n'importe quelle annotation

---

## üìú API ‚Äì Journalisation (`AuditLog`)

### ‚úÖ [POST] /logs  
Cr√©e une entr√©e de log

#### Input
```json
{
  "action": "submission_submitted",
  "targetType": "Submission",
  "targetId": "xyz123"
}
```

#### R√®gles
- `userId` et `timestamp` sont ajout√©s automatiquement

---

### ‚úÖ [GET] /logs?targetType=Submission&targetId=xyz123  
Liste les logs li√©s √† une entit√©

#### R√®gles
- Accessible √† `admin` uniquement


## üìò PRD ‚Äì Workflows d'√©tat (√âtape 3)

Ce document formalise les transitions possibles des champs `status` pour les principales entit√©s m√©tier. Ces r√®gles permettent de s√©curiser la logique m√©tier, guider l'impl√©mentation des API et pr√©venir les √©tats incoh√©rents.

---

### üîÅ `Task.status`

| Statut actuel | Transitions possibles                   |
|---------------|------------------------------------------|
| `draft`       | ‚Üí `published`, `archived`               |
| `published`   | ‚Üí `draft`, `archived`                   |
| `archived`    | (readonly)                              |

#### Notes
- Une t√¢che peut √™tre "d√©publi√©e" (repasse en `draft`)
- Une t√¢che archiv√©e devient en lecture seule

---

### üîÅ `Submission.status`

| Statut actuel | Transitions possibles                         |
|---------------|------------------------------------------------|
| `draft`       | ‚Üí `submitted`, `archived`                      |
| `submitted`   | ‚Üí `corrected`, `archived`                      |
| `corrected`   | ‚Üí `archived`                                   |
| `archived`    | (readonly)                                     |

#### Notes
- Le statut `in_review` est supprim√© pour simplification
- Une soumission peut √™tre archiv√©e √† tout moment (ex : erreur, retrait)

---

### üîÅ `Correction.status`

| Statut actuel | Transitions possibles         |
|---------------|-------------------------------|
| `in_progress` | ‚Üí `completed`                 |
| `completed`   | ‚Üí `in_progress` (admin/teacher)|

#### Notes
- Une correction finalis√©e peut √™tre r√©ouverte si besoin
- Historique des modifications tra√ßable via `AuditLog`

---

### üîí Permissions g√©n√©rales sur les transitions

| Entit√©      | Transitions contr√¥l√©es par         |
|-------------|-------------------------------------|
| `Task`      | Enseignant cr√©ateur ou admin        |
| `Submission`| √âl√®ve auteur ou enseignant de classe|
| `Correction`| Enseignant ou admin                 |

Les validations c√¥t√© backend doivent v√©rifier la transition et l'autorisation de l'utilisateur avant mise √† jour.



## üìò PRD ‚Äì Workflows d'√©tat (√âtape 3)

Ce document formalise les transitions possibles des champs `status` pour les principales entit√©s m√©tier. Ces r√®gles permettent de s√©curiser la logique m√©tier, guider l'impl√©mentation des API et pr√©venir les √©tats incoh√©rents.

---

### üîÅ `Task.status`

| Statut actuel | Transitions possibles                   |
|---------------|------------------------------------------|
| `draft`       | ‚Üí `published`, `archived`               |
| `published`   | ‚Üí `draft`, `archived`                   |
| `archived`    | (readonly)                              |

#### Notes
- Une t√¢che peut √™tre "d√©publi√©e" (repasse en `draft`)
- Une t√¢che archiv√©e devient en lecture seule

---

### üîÅ `Submission.status`

| Statut actuel | Transitions possibles                         |
|---------------|------------------------------------------------|
| `draft`       | ‚Üí `submitted`, `archived`                      |
| `submitted`   | ‚Üí `corrected`, `archived`                      |
| `corrected`   | ‚Üí `archived`                                   |
| `archived`    | (readonly)                                     |

#### Notes
- Le statut `in_review` est supprim√© pour simplification
- Une soumission peut √™tre archiv√©e √† tout moment (ex : erreur, retrait)

---

### üîÅ `Correction.status`

| Statut actuel | Transitions possibles         |
|---------------|-------------------------------|
| `in_progress` | ‚Üí `completed`                 |
| `completed`   | ‚Üí `in_progress` (admin/teacher)|

#### Notes
- Une correction finalis√©e peut √™tre r√©ouverte si besoin
- Historique des modifications tra√ßable via `AuditLog`

---

### üîí Permissions g√©n√©rales sur les transitions

| Entit√©      | Transitions contr√¥l√©es par         |
|-------------|-------------------------------------|
| `Task`      | Enseignant cr√©ateur ou admin        |
| `Submission`| √âl√®ve auteur ou enseignant de classe|
| `Correction`| Enseignant ou admin                 |

Les validations c√¥t√© backend doivent v√©rifier la transition et l'autorisation de l'utilisateur avant mise √† jour.

---

## üõ°Ô∏è Permissions par ressource et action

| Ressource     | Action                | R√¥les autoris√©s                          |
|---------------|-----------------------|------------------------------------------|
| `Class`       | Cr√©er                 | Teacher, Admin                           |
| `Class`       | Voir                  | Membre de la classe, Admin               |
| `Class`       | Rejoindre             | Utilisateur authentifi√© avec code        |
| `Class`       | Voir membres          | Teacher de la classe, Admin              |
| `Class`       | Archiver              | Teacher, Admin                           |
| `Task`        | Cr√©er / Modifier      | Teacher de la classe, Admin              |
| `Task`        | Voir                  | Membres de la classe (selon visibilit√©)  |
| `Task`        | Publier / Archiver    | Teacher, Admin                           |
| `Submission`  | Cr√©er / Modifier      | √âl√®ve auteur, ou Teacher pour un √©l√®ve   |
| `Submission`  | Voir (sa propre)      | √âl√®ve auteur                             |
| `Submission`  | Voir (toutes)         | Teacher de la classe, Admin              |
| `Correction`  | Cr√©er / Modifier      | Teacher de la classe, Admin              |
| `Correction`  | Voir                  | √âl√®ve concern√©, Teacher, Admin           |
| `Comment`     | Cr√©er                 | Membres de la classe                     |
| `Comment`     | Modifier / Supprimer  | Auteur du commentaire, Teacher, Admin    |
| `Comment`     | Voir                  | Membres de la classe                     |
| `Annotation`  | Cr√©er / Modifier      | Teacher de la classe, Admin              |
| `Annotation`  | Voir                  | √âl√®ve concern√©, Teacher de la classe, Admin |
| `AuditLog`    | Cr√©er (auto backend)  | Tous                                     |
| `AuditLog`    | Lire                  | Admin uniquement (ou √©largissable)       |

---

## üìÅ Structure sugg√©r√©e du projet NestJS

Voici une arborescence propos√©e pour organiser proprement les modules, en coh√©rence avec le PRD :

```
src/
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îú‚îÄ‚îÄ users/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.controller.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.dto.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.interface.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.module.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.schema.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ classes/
‚îÇ   ‚îú‚îÄ‚îÄ memberships/
‚îÇ   ‚îú‚îÄ‚îÄ tasks/
‚îÇ   ‚îú‚îÄ‚îÄ submissions/
‚îÇ   ‚îú‚îÄ‚îÄ corrections/
‚îÇ   ‚îú‚îÄ‚îÄ comments/
‚îÇ   ‚îú‚îÄ‚îÄ annotations/
‚îÇ   ‚îî‚îÄ‚îÄ audit-log/
‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îú‚îÄ‚îÄ guards/
‚îÇ   ‚îú‚îÄ‚îÄ interceptors/
‚îÇ   ‚îú‚îÄ‚îÄ decorators/
‚îÇ   ‚îî‚îÄ‚îÄ filters/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ s3.config.ts (ex: pour uploads s√©curis√©s)
‚îú‚îÄ‚îÄ main.ts
‚îî‚îÄ‚îÄ app.module.ts
```

Chaque dossier `module` peut suivre le pattern : controller + service + schema + DTOs, avec tests unitaires √† part.


## üèóÔ∏è Architecture backend et choix techniques

### üì¶ Base de donn√©es
Le projet utilise **MongoDB** comme base de donn√©es principale, avec Mongoose pour la couche ODM. Chaque entit√© m√©tier correspond √† un `@Schema()` d√©cor√© pour Mongoose.

Cependant, par souci de d√©couplage :

- **L'application n'utilise jamais Mongoose directement dans les services m√©tier**
- Une **interface de repository** est d√©finie pour chaque entit√©
- Une **impl√©mentation Mongoose** (nomm√©e `Mongo<Class>Repository`) est inject√©e dans le module

Ce choix permet de :
- Faciliter les tests (ex: `InMemory<Class>Repository`)
- Pr√©parer une future migration √©ventuelle (PostgreSQL, etc.)

### üß± Exemple de structure (pattern hexagonal l√©ger)

```
modules/
‚îú‚îÄ‚îÄ tasks/
‚îÇ   ‚îú‚îÄ‚îÄ task.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ task.service.ts (utilise ITaskRepository)
‚îÇ   ‚îú‚îÄ‚îÄ task.repository.ts (interface)
‚îÇ   ‚îú‚îÄ‚îÄ mongo-task.repository.ts (impl√©mentation mongoose)
```




